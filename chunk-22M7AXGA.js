import{b as z}from"./chunk-F224JCPE.js";import{f as ln}from"./chunk-FF2NHPLS.js";import{a as C}from"./chunk-PTJ4CXVK.js";import{a as an}from"./chunk-Q7L6LLAK.js";var _=function(n){return n[n.NO_COMPRESSION=0]="NO_COMPRESSION",n[n.RLE_COMPRESSION=1]="RLE_COMPRESSION",n[n.ZIPS_COMPRESSION=2]="ZIPS_COMPRESSION",n[n.ZIP_COMPRESSION=3]="ZIP_COMPRESSION",n[n.PIZ_COMPRESSION=4]="PIZ_COMPRESSION",n[n.PXR24_COMPRESSION=5]="PXR24_COMPRESSION",n}(_||{}),cn=function(n){return n[n.INCREASING_Y=0]="INCREASING_Y",n[n.DECREASING_Y=1]="DECREASING_Y",n}(cn||{}),G=Fn();function Fn(){let n=new ArrayBuffer(4),t=new Float32Array(n),e=new Uint32Array(n),a=new Uint32Array(512),r=new Uint32Array(512);for(let l=0;l<256;++l){let i=l-127;i<-27?(a[l]=0,a[l|256]=32768,r[l]=24,r[l|256]=24):i<-14?(a[l]=1024>>-i-14,a[l|256]=1024>>-i-14|32768,r[l]=-i-1,r[l|256]=-i-1):i<=15?(a[l]=i+15<<10,a[l|256]=i+15<<10|32768,r[l]=13,r[l|256]=13):i<128?(a[l]=31744,a[l|256]=64512,r[l]=24,r[l|256]=24):(a[l]=31744,a[l|256]=64512,r[l]=13,r[l|256]=13)}let s=new Uint32Array(2048),o=new Uint32Array(64),c=new Uint32Array(64);for(let l=1;l<1024;++l){let i=l<<13,u=0;for(;(i&8388608)===0;)i<<=1,u-=8388608;i&=-8388609,u+=947912704,s[l]=i|u}for(let l=1024;l<2048;++l)s[l]=939524096+(l-1024<<13);for(let l=1;l<31;++l)o[l]=l<<23;o[31]=1199570944,o[32]=2147483648;for(let l=33;l<63;++l)o[l]=2147483648+(l-32<<23);o[63]=3347054592;for(let l=1;l<64;++l)l!==32&&(c[l]=1024);return{floatView:t,uint32View:e,baseTable:a,shiftTable:r,mantissaTable:s,exponentTable:o,offsetTable:c}}function Y(n,t){let e=new Uint8Array(n),a=0;for(;e[t.value+a]!=0;)a+=1;let r=new TextDecoder().decode(e.slice(t.value,t.value+a));return t.value=t.value+a+1,r}function g(n,t){let e=n.getInt32(t.value,!0);return t.value+=4,e}function v(n,t){let e=n.getUint32(t.value,!0);return t.value+=4,e}function L(n,t){let e=n.getUint8(t.value);return t.value+=1,e}function D(n,t){let e=n.getUint16(t.value,!0);return t.value+=2,e}function q(n,t){let e=n[t.value];return t.value+=1,e}function un(n,t){let e;return"getBigInt64"in DataView.prototype?e=Number(n.getBigInt64(t.value,!0)):e=n.getUint32(t.value+4,!0)+Number(n.getUint32(t.value,!0)<<32),t.value+=8,e}function m(n,t){let e=n.getFloat32(t.value,!0);return t.value+=4,e}function pn(n,t){return Mn(D(n,t))}function Mn(n){let t=(n&31744)>>10,e=n&1023;return(n>>15?-1:1)*(t?t===31?e?NaN:1/0:Math.pow(2,t-15)*(1+e/1024):6103515625e-14*(e/1024))}function Ln(n){if(Math.abs(n)>65504)throw new Error("Value out of range.Consider using float instead of half-float.");n=ln(n,-65504,65504),G.floatView[0]=n;let t=G.uint32View[0],e=t>>23&511;return G.baseTable[e]+((t&8388607)>>G.shiftTable[e])}function fn(n,t){return Ln(m(n,t))}function Hn(n,t,e){let a=new TextDecoder().decode(new Uint8Array(n).slice(t.value,t.value+e));return t.value=t.value+e,a}function Zn(n,t){let e=g(n,t),a=v(n,t);return[e,a]}function kn(n,t){let e=v(n,t),a=v(n,t);return[e,a]}function Bn(n,t){let e=m(n,t),a=m(n,t);return[e,a]}function zn(n,t){let e=m(n,t),a=m(n,t),r=m(n,t);return[e,a,r]}function Gn(n,t,e){let a=t.value,r=[];for(;t.value<a+e-1;){let s=Y(n.buffer,t),o=g(n,t),c=L(n,t);t.value+=3;let l=g(n,t),i=g(n,t);r.push({name:s,pixelType:o,pLinear:c,xSampling:l,ySampling:i})}return t.value+=1,r}function Wn(n,t){let e=m(n,t),a=m(n,t),r=m(n,t),s=m(n,t),o=m(n,t),c=m(n,t),l=m(n,t),i=m(n,t);return{redX:e,redY:a,greenX:r,greenY:s,blueX:o,blueY:c,whiteX:l,whiteY:i}}function Yn(n,t){return L(n,t)}function Xn(n,t){let e=g(n,t),a=g(n,t),r=g(n,t),s=g(n,t);return{xMin:e,yMin:a,xMax:r,yMax:s}}function Kn(n,t){let e=L(n,t);return cn[e]}function hn(n,t,e,a){switch(e){case"string":case"stringvector":case"iccProfile":return Hn(n.buffer,t,a);case"chlist":return Gn(n,t,a);case"chromaticities":return Wn(n,t);case"compression":return Yn(n,t);case"box2i":return Xn(n,t);case"lineOrder":return Kn(n,t);case"float":return m(n,t);case"v2f":return Bn(n,t);case"v3f":return zn(n,t);case"int":return g(n,t);case"rational":return Zn(n,t);case"timecode":return kn(n,t);case"preview":return t.value+=a,"skipped";default:t.value+=a;return}}function $(n){for(let t=1;t<n.length;t++){let e=n[t-1]+n[t]-128;n[t]=e}}function J(n,t){let e=0,a=Math.floor((n.length+1)/2),r=0,s=n.length-1;for(;!(r>s||(t[r++]=n[e++],r>s));)t[r++]=n[a++]}var qn=20000630;function Q(n,t){if(n.getUint32(0,!0)!=qn)throw new Error("Incorrect OpenEXR format");let e=n.getUint8(4),a=n.getUint8(5),r={singleTile:!!(a&2),longName:!!(a&4),deepFormat:!!(a&8),multiPart:!!(a&16)};t.value=8;let s={},o=!0;for(;o;){let c=Y(n.buffer,t);if(!c)o=!1;else{let l=Y(n.buffer,t),i=v(n,t),u=hn(n,t,l,i);u===void 0?C.Warn(`Unknown header attribute type ${l}'.`):s[c]=u}}if((a&-5)!=0)throw new Error("Unsupported file format");return an({version:e,spec:r},s)}var In=16,Qn=1<<In-1,En=(1<<In)-1;function Un(n,t){let e=0;for(let r=0;r<65536;++r)(r==0||n[r>>3]&1<<(r&7))&&(t[e++]=r);let a=e-1;for(;e<65536;)t[e++]=0;return a}function Vn(n){for(let t=0;t<16384;t++)n[t]={},n[t].len=0,n[t].lit=0,n[t].p=null}function yn(n,t,e,a,r){for(;e<n;)t=t<<8|q(a,r),e+=8;return e-=n,{l:t>>e&(1<<n)-1,c:t,lc:e}}function j(n,t,e,a){return n=n<<8|q(e,a),t+=8,{c:n,lc:t}}function V(n,t,e,a,r,s,o,c,l){if(n==t){if(a<8){let f=j(e,a,r,s);e=f.c,a=f.lc}a-=8;let i=e>>a;if(i=new Uint8Array([i])[0],c.value+i>l)return null;let u=o[c.value-1];for(;i-- >0;)o[c.value++]=u}else if(c.value<l)o[c.value++]=n;else return null;return{c:e,lc:a}}var H=new Array(59);function jn(n){for(let e=0;e<=58;++e)H[e]=0;for(let e=0;e<65537;++e)H[n[e]]+=1;let t=0;for(let e=58;e>0;--e){let a=t+H[e]>>1;H[e]=t,t=a}for(let e=0;e<65537;++e){let a=n[e];a>0&&(n[e]=a|H[a]++<<6)}}function dn(n,t,e,a,r,s){let o=t,c=0,l=0;for(;a<=r;a++){if(o.value-t.value>e)return;let i=yn(6,c,l,n,o),u=i.l;if(c=i.c,l=i.lc,s[a]=u,u==63){if(o.value-t.value>e)throw new Error("Error in HufUnpackEncTable");i=yn(8,c,l,n,o);let f=i.l+6;if(c=i.c,l=i.lc,a+f>r+1)throw new Error("Error in HufUnpackEncTable");for(;f--;)s[a++]=0;a--}else if(u>=59){let f=u-59+2;if(a+f>r+1)throw new Error("Error in HufUnpackEncTable");for(;f--;)s[a++]=0;a--}}jn(s)}function vn(n){return n&63}function On(n){return n>>6}function nt(n,t,e,a){for(;t<=e;t++){let r=On(n[t]),s=vn(n[t]);if(r>>s)throw new Error("Invalid table entry");if(s>14){let o=a[r>>s-14];if(o.len)throw new Error("Invalid table entry");if(o.lit++,o.p){let c=o.p;o.p=new Array(o.lit);for(let l=0;l<o.lit-1;++l)o.p[l]=c[l]}else o.p=new Array(1);o.p[o.lit-1]=t}else if(s){let o=0;for(let c=1<<14-s;c>0;c--){let l=a[(r<<14-s)+o];if(l.len||l.p)throw new Error("Invalid table entry");l.len=s,l.lit=t,o++}}}return!0}function tt(n,t,e,a,r,s,o,c,l){let i=0,u=0,f=o,S=Math.trunc(a.value+(r+7)/8);for(;a.value<S;){let p=j(i,u,e,a);for(i=p.c,u=p.lc;u>=14;){let x=i>>u-14&16383,w=t[x];if(w.len){u-=w.len;let h=V(w.lit,s,i,u,e,a,c,l,f);h&&(i=h.c,u=h.lc)}else{if(!w.p)throw new Error("hufDecode issues");let h;for(h=0;h<w.lit;h++){let I=vn(n[w.p[h]]);for(;u<I&&a.value<S;)p=j(i,u,e,a),i=p.c,u=p.lc;if(u>=I&&On(n[w.p[h]])==(i>>u-I&(1<<I)-1)){u-=I;let A=V(w.p[h],s,i,u,e,a,c,l,f);A&&(i=A.c,u=A.lc);break}}if(h==w.lit)throw new Error("HufDecode issues")}}}let O=8-r&7;for(i>>=O,u-=O;u>0;){let p=t[i<<14-u&16383];if(p.len){u-=p.len;let x=V(p.lit,s,i,u,e,a,c,l,f);x&&(i=x.c,u=x.lc)}else throw new Error("HufDecode issues")}return!0}function bn(n,t,e,a,r,s){let o={value:0},c=e.value,l=v(t,e),i=v(t,e);e.value+=4;let u=v(t,e);if(e.value+=4,l<0||l>=65537||i<0||i>=65537)throw new Error("Wrong HUF_ENCSIZE");let f=new Array(65537),S=new Array(16384);Vn(S);let O=a-(e.value-c);if(dn(n,e,O,l,i,f),u>8*(a-(e.value-c)))throw new Error("Wrong hufUncompress");nt(f,l,i,S),tt(f,S,n,e,u,i,s,r,o)}function d(n){return n&65535}function Sn(n){let t=d(n);return t>32767?t-65536:t}function F(n,t){let e=Sn(n),r=Sn(t),s=e+(r&1)+(r>>1),o=s,c=s-r;return{a:o,b:c}}function M(n,t){let e=d(n),a=d(t),r=e-(a>>1)&En;return{a:a+r-Qn&En,b:r}}function gn(n,t,e,a,r,s,o){let c=o<16384,l=e>r?r:e,i=1,u,f;for(;i<=l;)i<<=1;for(i>>=1,u=i,i>>=1;i>=1;){f=0;let S=f+s*(r-u),O=s*i,p=s*u,x=a*i,w=a*u,h,I,A,k;for(;f<=S;f+=p){let y=f,K=f+a*(e-u);for(;y<=K;y+=w){let b=y+x,U=y+O,B=U+x;if(c){let E=F(n[y+t],n[U+t]);h=E.a,A=E.b,E=F(n[b+t],n[B+t]),I=E.a,k=E.b,E=F(h,I),n[y+t]=E.a,n[b+t]=E.b,E=F(A,k),n[U+t]=E.a,n[B+t]=E.b}else{let E=M(n[y+t],n[U+t]);h=E.a,A=E.b,E=M(n[b+t],n[B+t]),I=E.a,k=E.b,E=M(h,I),n[y+t]=E.a,n[b+t]=E.b,E=M(A,k),n[U+t]=E.a,n[B+t]=E.b}}if(e&i){let b=y+O,U;c?U=F(n[y+t],n[b+t]):U=M(n[y+t],n[b+t]),h=U.a,n[b+t]=U.b,n[y+t]=h}}if(r&i){let y=f,K=f+a*(e-u);for(;y<=K;y+=w){let b=y+x,U;c?U=F(n[y+t],n[b+t]):U=M(n[y+t],n[b+t]),h=U.a,n[b+t]=U.b,n[y+t]=h}}u=i,i>>=1}return f}function Pn(n,t,e){for(let a=0;a<e;++a)t[a]=n[t[a]]}function An(n){let t=n.byteLength,e=[],a=0,r=new DataView(n);for(;t>0;){let s=r.getInt8(a++);if(s<0){let o=-s;t-=o+1;for(let c=0;c<o;c++)e.push(r.getUint8(a++))}else{let o=s;t-=2;let c=r.getUint8(a++);for(let l=0;l<o+1;l++)e.push(c)}}return e}function nn(n){return new DataView(n.array.buffer,n.offset.value,n.size)}function _n(n){let t=n.viewer.buffer.slice(n.offset.value,n.offset.value+n.size),e=new Uint8Array(An(t)),a=new Uint8Array(e.length);return $(e),J(e,a),new DataView(a.buffer)}function tn(n){let t=n.array.slice(n.offset.value,n.offset.value+n.size),e=fflate.unzlibSync(t),a=new Uint8Array(e.length);return $(e),J(e,a),new DataView(a.buffer)}function Nn(n){let t=n.array.slice(n.offset.value,n.offset.value+n.size),e=fflate.unzlibSync(t),a=n.lines*n.channels*n.width,r=n.type==1?new Uint16Array(a):new Uint32Array(a),s=0,o=0,c=new Array(4);for(let l=0;l<n.lines;l++)for(let i=0;i<n.channels;i++){let u=0;switch(n.type){case 1:c[0]=s,c[1]=c[0]+n.width,s=c[1]+n.width;for(let f=0;f<n.width;++f){let S=e[c[0]++]<<8|e[c[1]++];u+=S,r[o]=u,o++}break;case 2:c[0]=s,c[1]=c[0]+n.width,c[2]=c[1]+n.width,s=c[2]+n.width;for(let f=0;f<n.width;++f){let S=e[c[0]++]<<24|e[c[1]++]<<16|e[c[2]++]<<8;u+=S,r[o]=u,o++}break}}return new DataView(r.buffer)}function Tn(n){let t=n.viewer,e={value:n.offset.value},a=new Uint16Array(n.width*n.scanlineBlockSize*(n.channels*n.type)),r=new Uint8Array(8192),s=0,o=new Array(n.channels);for(let p=0;p<n.channels;p++)o[p]={},o[p].start=s,o[p].end=o[p].start,o[p].nx=n.width,o[p].ny=n.lines,o[p].size=n.type,s+=o[p].nx*o[p].ny*o[p].size;let c=D(t,e),l=D(t,e);if(l>=8192)throw new Error("Wrong PIZ_COMPRESSION BITMAP_SIZE");if(c<=l)for(let p=0;p<l-c+1;p++)r[p+c]=L(t,e);let i=new Uint16Array(65536),u=Un(r,i),f=v(t,e);bn(n.array,t,e,f,a,s);for(let p=0;p<n.channels;++p){let x=o[p];for(let w=0;w<o[p].size;++w)gn(a,x.start+w,x.nx,x.size,x.ny,x.nx*x.size,u)}Pn(i,a,s);let S=0,O=new Uint8Array(a.buffer.byteLength);for(let p=0;p<n.lines;p++)for(let x=0;x<n.channels;x++){let w=o[x],h=w.nx*w.size,I=new Uint8Array(a.buffer,w.end*2,h*2);O.set(I,S),S+=h*2,w.end+=h}return new DataView(O.buffer)}var P=function(n){return n[n.Float=0]="Float",n[n.HalfFloat=1]="HalfFloat",n}(P||{}),R=class{};R.DefaultOutputType=P.HalfFloat;R.FFLATEUrl="https://unpkg.com/fflate@0.8.2";async function en(n,t,e,a){let r={size:0,viewer:t,array:new Uint8Array(t.buffer),offset:e,width:n.dataWindow.xMax-n.dataWindow.xMin+1,height:n.dataWindow.yMax-n.dataWindow.yMin+1,channels:n.channels.length,channelLineOffsets:{},scanOrder:()=>0,bytesPerLine:0,outLineWidth:0,lines:0,scanlineBlockSize:0,inputSize:null,type:0,uncompress:null,getter:()=>0,format:5,outputChannels:0,decodeChannels:{},blockCount:null,byteArray:null,linearSpace:!1,textureType:0};switch(n.compression){case _.NO_COMPRESSION:r.lines=1,r.uncompress=nn;break;case _.RLE_COMPRESSION:r.lines=1,r.uncompress=_n;break;case _.ZIPS_COMPRESSION:r.lines=1,r.uncompress=tn,await z.LoadScriptAsync(R.FFLATEUrl);break;case _.ZIP_COMPRESSION:r.lines=16,r.uncompress=tn,await z.LoadScriptAsync(R.FFLATEUrl);break;case _.PIZ_COMPRESSION:r.lines=32,r.uncompress=Tn;break;case _.PXR24_COMPRESSION:r.lines=16,r.uncompress=Nn,await z.LoadScriptAsync(R.FFLATEUrl);break;default:throw new Error(_[n.compression]+" is unsupported")}r.scanlineBlockSize=r.lines;let s={};for(let i of n.channels)switch(i.name){case"R":case"G":case"B":case"A":s[i.name]=!0,r.type=i.pixelType;break;case"Y":s[i.name]=!0,r.type=i.pixelType;break;default:break}let o=!1;if(s.R&&s.G&&s.B&&s.A)r.outputChannels=4,r.decodeChannels={R:0,G:1,B:2,A:3};else if(s.R&&s.G&&s.B)o=!0,r.outputChannels=4,r.decodeChannels={R:0,G:1,B:2,A:3};else if(s.R&&s.G)r.outputChannels=2,r.decodeChannels={R:0,G:1};else if(s.R)r.outputChannels=1,r.decodeChannels={R:0};else if(s.Y)r.outputChannels=1,r.decodeChannels={Y:0};else throw new Error("EXRLoader.parse: file contains unsupported data channels.");if(r.type===1)switch(a){case P.Float:r.getter=pn,r.inputSize=2;break;case P.HalfFloat:r.getter=D,r.inputSize=2;break}else if(r.type===2)switch(a){case P.Float:r.getter=m,r.inputSize=4;break;case P.HalfFloat:r.getter=fn,r.inputSize=4}else throw new Error("Unsupported pixelType "+r.type+" for "+n.compression);r.blockCount=r.height/r.scanlineBlockSize;for(let i=0;i<r.blockCount;i++)un(t,e);let c=r.width*r.height*r.outputChannels;switch(a){case P.Float:r.byteArray=new Float32Array(c),r.textureType=1,o&&r.byteArray.fill(1,0,c);break;case P.HalfFloat:r.byteArray=new Uint16Array(c),r.textureType=2,o&&r.byteArray.fill(15360,0,c);break;default:throw new Error("Unsupported type: "+a)}let l=0;for(let i of n.channels)r.decodeChannels[i.name]!==void 0&&(r.channelLineOffsets[i.name]=l*r.width),l+=i.pixelType*2;return r.bytesPerLine=r.width*l,r.outLineWidth=r.width*r.outputChannels,n.lineOrder==="INCREASING_Y"?r.scanOrder=i=>i:r.scanOrder=i=>r.height-1-i,r.outputChannels==4?(r.format=5,r.linearSpace=!0):(r.format=6,r.linearSpace=!1),r}function rn(n,t,e,a){let r={value:0};for(let s=0;s<n.height/n.scanlineBlockSize;s++){let o=g(e,a)-t.dataWindow.yMin;n.size=v(e,a),n.lines=o+n.scanlineBlockSize>n.height?n.height-o:n.scanlineBlockSize;let l=n.size<n.lines*n.bytesPerLine&&n.uncompress?n.uncompress(n):nn(n);a.value+=n.size;for(let i=0;i<n.scanlineBlockSize;i++){let u=s*n.scanlineBlockSize,f=i+n.scanOrder(u);if(f>=n.height)continue;let S=i*n.bytesPerLine,O=(n.height-1-f)*n.outLineWidth;for(let p=0;p<n.channels;p++){let x=t.channels[p].name,w=n.channelLineOffsets[x],h=n.decodeChannels[x];if(h!==void 0){r.value=S+w;for(let I=0;I<n.width;I++){let A=O+I*n.outputChannels+h;n.byteArray&&(n.byteArray[A]=n.getter(l,r))}}}}}}var Cn=class{constructor(){this.supportCascades=!1}loadCubeData(t,e,a,r,s){throw".exr not supported in Cube."}loadData(t,e,a){let r=new DataView(t.buffer),s={value:0},o=Q(r,s);en(o,r,s,R.DefaultOutputType).then(c=>{rn(c,o,r,s);let l=o.dataWindow.xMax-o.dataWindow.xMin+1,i=o.dataWindow.yMax-o.dataWindow.yMin+1;a(l,i,e.generateMipMaps,!1,()=>{let u=e.getEngine();e.format=o.format,e.type=c.textureType,e.invertY=!1,e._gammaSpace=!o.linearSpace,c.byteArray&&u._uploadDataToTextureDirectly(e,c.byteArray,0,0,void 0,!0)})}).catch(c=>{C.Error("Failed to load EXR texture: ",c)})}};async function Nt(n){let t=new DataView(n),e={value:0},a=Q(t,e);try{let r=await en(a,t,e,P.Float);return rn(r,a,t,e),r.byteArray?{width:a.dataWindow.xMax-a.dataWindow.xMin+1,height:a.dataWindow.yMax-a.dataWindow.yMin+1,data:new Float32Array(r.byteArray)}:(C.Error("Failed to decode EXR data: No byte array available."),{width:0,height:0,data:null})}catch(r){C.Error("Failed to load EXR data: ",r)}return{width:0,height:0,data:null}}export{Cn as a,Nt as b};
