import{c as U,d as O,g as L,w as G}from"./chunk-UA5JYNEU.js";import{b}from"./chunk-O4XWCQHP.js";import{h as m}from"./chunk-B52P4PMX.js";import{b as H}from"./chunk-F224JCPE.js";import{i as B}from"./chunk-FF2NHPLS.js";import{C as F}from"./chunk-LSPFCJN7.js";import{a as E}from"./chunk-PTJ4CXVK.js";import{a as S,b as I}from"./chunk-Q7L6LLAK.js";var C=class{static ExpandRGBDTexture(r){let t=r._texture;if(!t||!r.isRGBD)return;let a=t.getEngine(),o=a.getCaps(),n=t.isReady,i=!1;o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?(i=!0,t.type=2):o.textureFloatRender&&o.textureFloatLinearFiltering&&(i=!0,t.type=1),i&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);let s=async()=>{let c=a.isWebGPU,h=c?1:0;t.isReady=!1,c?await import("./chunk-OFNS7QFI.js"):await import("./chunk-73KQUGBI.js");let u=new L("rgbdDecode","rgbdDecode",null,null,1,null,3,a,!1,void 0,t.type,void 0,null,!1,void 0,h);u.externalTextureSamplerBinding=!0;let f=a.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});u.onEffectCreatedObservable.addOnce(T=>{T.executeWhenCompiled(()=>{u.onApply=d=>{d._bindTexture("textureSampler",t),d.setFloat2("scale",1,1)},r.getScene().postProcessManager.directRender([u],f,!0),a.restoreDefaultFramebuffer(),a._releaseTexture(t),u&&u.dispose(),f._swapAndDie(t),t.isReady=!0})})};i&&(n?s():r.onLoadObservable.addOnce(s))}static async EncodeTextureToRGBD(r,t,a=0){return t.getEngine().isWebGPU?await import("./chunk-Z7V4GKRV.js"):await import("./chunk-2BZVHN3V.js"),await G("rgbdEncode",r,t,a,1,5)}};b.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(b.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=O.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});var M="image/png",V=2,W=[134,22,135,150,246,214,150,54];function j(e){let r=new DataView(e.buffer,e.byteOffset,e.byteLength),t=0;for(let i=0;i<W.length;i++)if(r.getUint8(t++)!==W[i])return E.Error("Not a babylon environment map"),null;let a="",o=0;for(;o=r.getUint8(t++);)a+=String.fromCharCode(o);let n=JSON.parse(a);return n=v(n),n.binaryDataPosition=t,n.specular&&(n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function v(e){if(e.version>V)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${V}".`);return e.version===2||(e=I(S({},e),{version:2,imageType:M})),e}function Q(e,r){r=v(r);let t=r.specular,a=Math.log2(r.width);if(a=Math.round(a)+1,t.mipmaps.length!==6*a)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);let o=new Array(a);for(let n=0;n<a;n++){o[n]=new Array(6);for(let i=0;i<6;i++){let s=t.mipmaps[n*6+i];o[n][i]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+s.position,s.length)}}return o}function q(e,r){r=v(r);let t=new Array(6),a=r.irradiance?.irradianceTexture;if(a){if(a.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${a.faces.length}"`);for(let o=0;o<6;o++){let n=a.faces[o];t[o]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+n.position,n.length)}}return t}function Y(e,r,t){t=v(t);let a=t.specular;if(!a)return Promise.resolve([]);e._lodGenerationScale=a.lodGenerationScale;let o=[],n=Q(r,t);o.push(K(e,n,t.imageType));let i=t.irradiance?.irradianceTexture;if(i){let s=q(r,t),c=null;t.irradiance?.irradianceTexture?.dominantDirection&&(c=m.FromArray(t.irradiance.irradianceTexture.dominantDirection)),o.push(X(e,s,i.size,t.imageType,c))}return Promise.all(o)}async function k(e,r,t,a,o,n,i,s,c,h,u){return await new Promise((f,T)=>{if(t){let d=r.createTexture(null,!0,!0,null,1,null,l=>{T(l)},e);a?.onEffectCreatedObservable.addOnce(l=>{l.executeWhenCompiled(()=>{a.externalTextureSamplerBinding=!0,a.onApply=p=>{p._bindTexture("textureSampler",d),p.setFloat2("scale",1,r._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},r.scenes.length&&(r.scenes[0].postProcessManager.directRender([a],h,!0,n,i),r.restoreDefaultFramebuffer(),d.dispose(),URL.revokeObjectURL(o),f())})})}else{if(r._uploadImageToTexture(u,e,n,i),s){let d=c[i];d&&r._uploadImageToTexture(d._texture,e,n,0)}f()}})}async function K(e,r,t=M){let a=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,a.updateTextureSamplingMode(3,e),await $(e,r,!0,t),e.isReady=!0}async function X(e,r,t,a=M,o=null){let n=e.getEngine(),i=new F(n,5),s=new b(n,i);e._irradianceTexture=s,s._dominantDirection=o,i.isCube=!0,i.format=5,i.type=0,i.generateMipMaps=!0,i._cachedAnisotropicFilteringLevel=null,i.generateMipMaps=!0,i.width=t,i.height=t,n.updateTextureSamplingMode(3,i),await $(i,[r],!1,a),n.generateMipMapsForCubemap(i),i.isReady=!0}async function $(e,r,t,a=M){if(!H.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");let o=B(e.width)+1,n=e.getEngine(),i=!1,s=!1,c=null,h=null,u=null,f=n.getCaps();f.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?f.textureHalfFloatRender&&f.textureHalfFloatLinearFiltering?(i=!0,e.type=2):f.textureFloatRender&&f.textureFloatLinearFiltering&&(i=!0,e.type=1):i=!1:(i=!1,s=t);let T=0;if(i)n.isWebGPU?(T=1,await import("./chunk-OFNS7QFI.js")):await import("./chunk-73KQUGBI.js"),c=new L("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,e.type,void 0,null,!1,void 0,T),e._isRGBD=!1,e.invertY=!1,h=n.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,s){u={};let p=e._lodGenerationScale,x=e._lodGenerationOffset;for(let y=0;y<3;y++){let P=1-y/2,g=x,D=(o-1)*p+x,z=g+(D-g)*P,A=Math.round(Math.min(Math.max(z,0),D)),R=new F(n,2);R.isCube=!0,R.invertY=!0,R.generateMipMaps=!1,n.updateTextureSamplingMode(2,R);let _=new b(null);switch(_._isCube=!0,_._texture=R,u[A]=_,y){case 0:e._lodTextureLow=_;break;case 1:e._lodTextureMid=_;break;case 2:e._lodTextureHigh=_;break}}}let d=[];for(let l=0;l<r.length;l++)for(let p=0;p<6;p++){let x=r[l][p],y=new Blob([x],{type:a}),w=URL.createObjectURL(y),P;if(n._features.forceBitmapOverHTMLImageElement)P=n.createImageBitmap(y,{premultiplyAlpha:"none"}).then(async g=>await k(g,n,i,c,w,p,l,s,u,h,e));else{let g=new Image;g.src=w,P=new Promise((D,z)=>{g.onload=()=>{k(g,n,i,c,w,p,l,s,u,h,e).then(()=>D()).catch(A=>{z(A)})},g.onerror=A=>{z(A)}})}d.push(P)}if(await Promise.all(d),r.length<o){let l,p=Math.pow(2,o-1-r.length),x=p*p*4;switch(e.type){case 0:{l=new Uint8Array(x);break}case 2:{l=new Uint16Array(x);break}case 1:{l=new Float32Array(x);break}}for(let y=r.length;y<o;y++)for(let w=0;w<6;w++)n._uploadArrayBufferViewToTexture(h?.texture||e,l,w,y)}if(h){let l=e._irradianceTexture;e._irradianceTexture=null,n._releaseTexture(e),h._swapAndDie(e),e._irradianceTexture=l}c&&c.dispose(),s&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function N(e,r){r=v(r);let t=r.irradiance;if(!t)return;let a=new U;m.FromArrayToRef(t.x,0,a.x),m.FromArrayToRef(t.y,0,a.y),m.FromArrayToRef(t.z,0,a.z),m.FromArrayToRef(t.xx,0,a.xx),m.FromArrayToRef(t.yy,0,a.yy),m.FromArrayToRef(t.zz,0,a.zz),m.FromArrayToRef(t.yz,0,a.yz),m.FromArrayToRef(t.zx,0,a.zx),m.FromArrayToRef(t.xy,0,a.xy),e._sphericalPolynomial=a}var J=class{constructor(){this.supportCascades=!1}loadCubeData(r,t,a,o,n){if(Array.isArray(r))return;let i=j(r);if(i){t.width=i.width,t.height=i.width;try{N(t,i),Y(t,r,i).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),o&&o()},s=>{n?.("Can not upload environment levels",s)})}catch(s){n?.("Can not upload environment file",s)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}};export{C as a,j as b,Q as c,N as d,J as e};
