import{a as w}from"./chunk-A3WFPZFR.js";import{a as P,b as pe,c as k,d as ge,e as me}from"./chunk-CWQQB2EJ.js";import{a as _e,b as y}from"./chunk-65CEQG3Z.js";import{b as m}from"./chunk-4UCLQGBG.js";import{a as C}from"./chunk-PTJ4CXVK.js";import{a as v}from"./chunk-L3UYHT7M.js";var V={};function Ce(s,t,e=""){return e+(t?t+`
`:"")+s}function W(s,t,e,i,r,n,a){let h=a||V.loadFile;if(h)return h(s,t,e,i,r,n);throw w("FileTools")}function xe(s,t,e,i){if(s){t?s.IS_NDC_HALF_ZRANGE="":delete s.IS_NDC_HALF_ZRANGE,e?s.USE_REVERSE_DEPTHBUFFER="":delete s.USE_REVERSE_DEPTHBUFFER,i?s.USE_EXACT_SRGB_CONVERSIONS="":delete s.USE_EXACT_SRGB_CONVERSIONS;return}else{let r="";return t&&(r+="#define IS_NDC_HALF_ZRANGE"),e&&(r&&(r+=`
`),r+="#define USE_REVERSE_DEPTHBUFFER"),i&&(r&&(r+=`
`),r+="#define USE_EXACT_SRGB_CONVERSIONS"),r}}function gt(s,t,e=!1,i){switch(s){case 3:{let n=t instanceof ArrayBuffer?new Int8Array(t):new Int8Array(t);return i&&n.set(new Int8Array(i)),n}case 0:{let n=t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t);return i&&n.set(new Uint8Array(i)),n}case 4:{let n=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(e?t/2:t);return i&&n.set(new Int16Array(i)),n}case 5:case 8:case 9:case 10:case 2:{let n=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(e?t/2:t);return i&&n.set(new Uint16Array(i)),n}case 6:{let n=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(e?t/4:t);return i&&n.set(new Int32Array(i)),n}case 7:case 11:case 12:case 13:case 14:case 15:{let n=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(e?t/4:t);return i&&n.set(new Uint32Array(i)),n}case 1:{let n=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(e?t/4:t);return i&&n.set(new Float32Array(i)),n}}let r=t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t);return i&&r.set(new Uint8Array(i)),r}var H=[],be=class{static SetImmediate(t){H.length===0&&setTimeout(()=>{let e=H;H=[];for(let i of e)i()},1),H.push(t)}};function Se(s,t,e){try{if(s())return t(),!0}catch(i){return e?.(i),!0}return!1}var ye=(s,t,e,i=16,r=3e4,n=!0,a)=>{if(n&&Se(s,t,e))return null;let h=setInterval(()=>{Se(s,t,e)?clearInterval(h):(r-=i,r<0&&(clearInterval(h),e?.(new Error("Operation timed out after maximum retries. "+(a||"")),!0)))},i);return()=>clearInterval(h)};var G=class{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(t){t&&this.program&&t(this.program)}setEngine(t){this.engine=t}_fillEffectInformation(t,e,i,r,n,a,h,o){let l=this.engine;if(l.supportsUniformBuffers)for(let u in e)t.bindUniformBlock(u,e[u]);this.engine.getUniforms(this,i).forEach((u,p)=>{r[i[p]]=u}),this._uniforms=r;let c;for(c=0;c<n.length;c++)t.getUniform(n[c])==null&&(n.splice(c,1),c--);n.forEach((u,p)=>{a[u]=p});for(let u of l.getAttributes(this,h))o.push(u)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(t,e){let i=this._valueCache[t],r=e.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[t]=r,!0)}_cacheFloat2(t,e,i){let r=this._valueCache[t];if(!r||r.length!==2)return r=[e,i],this._valueCache[t]=r,!0;let n=!1;return r[0]!==e&&(r[0]=e,n=!0),r[1]!==i&&(r[1]=i,n=!0),n}_cacheFloat3(t,e,i,r){let n=this._valueCache[t];if(!n||n.length!==3)return n=[e,i,r],this._valueCache[t]=n,!0;let a=!1;return n[0]!==e&&(n[0]=e,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==r&&(n[2]=r,a=!0),a}_cacheFloat4(t,e,i,r,n){let a=this._valueCache[t];if(!a||a.length!==4)return a=[e,i,r,n],this._valueCache[t]=a,!0;let h=!1;return a[0]!==e&&(a[0]=e,h=!0),a[1]!==i&&(a[1]=i,h=!0),a[2]!==r&&(a[2]=r,h=!0),a[3]!==n&&(a[3]=n,h=!0),h}setInt(t,e){let i=this._valueCache[t];i!==void 0&&i===e||this.engine.setInt(this._uniforms[t],e)&&(this._valueCache[t]=e)}setInt2(t,e,i){this._cacheFloat2(t,e,i)&&(this.engine.setInt2(this._uniforms[t],e,i)||(this._valueCache[t]=null))}setInt3(t,e,i,r){this._cacheFloat3(t,e,i,r)&&(this.engine.setInt3(this._uniforms[t],e,i,r)||(this._valueCache[t]=null))}setInt4(t,e,i,r,n){this._cacheFloat4(t,e,i,r,n)&&(this.engine.setInt4(this._uniforms[t],e,i,r,n)||(this._valueCache[t]=null))}setIntArray(t,e){this._valueCache[t]=null,this.engine.setIntArray(this._uniforms[t],e)}setIntArray2(t,e){this._valueCache[t]=null,this.engine.setIntArray2(this._uniforms[t],e)}setIntArray3(t,e){this._valueCache[t]=null,this.engine.setIntArray3(this._uniforms[t],e)}setIntArray4(t,e){this._valueCache[t]=null,this.engine.setIntArray4(this._uniforms[t],e)}setUInt(t,e){let i=this._valueCache[t];i!==void 0&&i===e||this.engine.setUInt(this._uniforms[t],e)&&(this._valueCache[t]=e)}setUInt2(t,e,i){this._cacheFloat2(t,e,i)&&(this.engine.setUInt2(this._uniforms[t],e,i)||(this._valueCache[t]=null))}setUInt3(t,e,i,r){this._cacheFloat3(t,e,i,r)&&(this.engine.setUInt3(this._uniforms[t],e,i,r)||(this._valueCache[t]=null))}setUInt4(t,e,i,r,n){this._cacheFloat4(t,e,i,r,n)&&(this.engine.setUInt4(this._uniforms[t],e,i,r,n)||(this._valueCache[t]=null))}setUIntArray(t,e){this._valueCache[t]=null,this.engine.setUIntArray(this._uniforms[t],e)}setUIntArray2(t,e){this._valueCache[t]=null,this.engine.setUIntArray2(this._uniforms[t],e)}setUIntArray3(t,e){this._valueCache[t]=null,this.engine.setUIntArray3(this._uniforms[t],e)}setUIntArray4(t,e){this._valueCache[t]=null,this.engine.setUIntArray4(this._uniforms[t],e)}setArray(t,e){this._valueCache[t]=null,this.engine.setArray(this._uniforms[t],e)}setArray2(t,e){this._valueCache[t]=null,this.engine.setArray2(this._uniforms[t],e)}setArray3(t,e){this._valueCache[t]=null,this.engine.setArray3(this._uniforms[t],e)}setArray4(t,e){this._valueCache[t]=null,this.engine.setArray4(this._uniforms[t],e)}setMatrices(t,e){e&&(this._valueCache[t]=null,this.engine.setMatrices(this._uniforms[t],e))}setMatrix(t,e){this._cacheMatrix(t,e)&&(this.engine.setMatrices(this._uniforms[t],e.asArray())||(this._valueCache[t]=null))}setMatrix3x3(t,e){this._valueCache[t]=null,this.engine.setMatrix3x3(this._uniforms[t],e)}setMatrix2x2(t,e){this._valueCache[t]=null,this.engine.setMatrix2x2(this._uniforms[t],e)}setFloat(t,e){let i=this._valueCache[t];i!==void 0&&i===e||this.engine.setFloat(this._uniforms[t],e)&&(this._valueCache[t]=e)}setVector2(t,e){this._cacheFloat2(t,e.x,e.y)&&(this.engine.setFloat2(this._uniforms[t],e.x,e.y)||(this._valueCache[t]=null))}setFloat2(t,e,i){this._cacheFloat2(t,e,i)&&(this.engine.setFloat2(this._uniforms[t],e,i)||(this._valueCache[t]=null))}setVector3(t,e){this._cacheFloat3(t,e.x,e.y,e.z)&&(this.engine.setFloat3(this._uniforms[t],e.x,e.y,e.z)||(this._valueCache[t]=null))}setFloat3(t,e,i,r){this._cacheFloat3(t,e,i,r)&&(this.engine.setFloat3(this._uniforms[t],e,i,r)||(this._valueCache[t]=null))}setVector4(t,e){this._cacheFloat4(t,e.x,e.y,e.z,e.w)&&(this.engine.setFloat4(this._uniforms[t],e.x,e.y,e.z,e.w)||(this._valueCache[t]=null))}setQuaternion(t,e){this._cacheFloat4(t,e.x,e.y,e.z,e.w)&&(this.engine.setFloat4(this._uniforms[t],e.x,e.y,e.z,e.w)||(this._valueCache[t]=null))}setFloat4(t,e,i,r,n){this._cacheFloat4(t,e,i,r,n)&&(this.engine.setFloat4(this._uniforms[t],e,i,r,n)||(this._valueCache[t]=null))}setColor3(t,e){this._cacheFloat3(t,e.r,e.g,e.b)&&(this.engine.setFloat3(this._uniforms[t],e.r,e.g,e.b)||(this._valueCache[t]=null))}setColor4(t,e,i){this._cacheFloat4(t,e.r,e.g,e.b,i)&&(this.engine.setFloat4(this._uniforms[t],e.r,e.g,e.b,i)||(this._valueCache[t]=null))}setDirectColor4(t,e){this._cacheFloat4(t,e.r,e.g,e.b,e.a)&&(this.engine.setFloat4(this._uniforms[t],e.r,e.g,e.b,e.a)||(this._valueCache[t]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}};var se=new WeakMap,je={_webGLVersion:2,cachedPipelines:{}};function A(s){let t=se.get(s);if(!t){if(!s)return je;t={_webGLVersion:s.TEXTURE_BINDING_3D?2:1,_context:s,parallelShaderCompile:s.getExtension("KHR_parallel_shader_compile")||void 0,cachedPipelines:{}},se.set(s,t)}return t}function yt(s){se.delete(s)}function ze(s,t,e,i,r,n){let a=A(i);n||(n=a._createShaderProgramInjection??we);let h=re(t,"vertex",i,a._contextWasLost),o=re(e,"fragment",i,a._contextWasLost);return n(s,h,o,i,r,a.validateShaderPrograms)}function Qe(s,t,e,i,r,n=null,a){let h=A(r);a||(a=h._createShaderProgramInjection??we);let o=h._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=Fe(t,"vertex",i,o,r,h._contextWasLost),f=Fe(e,"fragment",i,o,r,h._contextWasLost);return a(s,l,f,r,n,h.validateShaderPrograms)}function Ft(s,t){let e=new G,i=A(s);return i.parallelShaderCompile&&!i.disableParallelShaderCompile&&(e.isParallelCompiled=!0),e.context=i._context,e}function we(s,t,e,i,r=null,n){let a=i.createProgram();if(s.program=a,!a)throw new Error("Unable to create program");return i.attachShader(a,t),i.attachShader(a,e),i.linkProgram(a),s.context=i,s.vertexShader=t,s.fragmentShader=e,s.isParallelCompiled||ve(s,i,n),a}function wt(s,t,e){let i=s;if(i._isDisposed)return!1;let r=A(t);return r&&r.parallelShaderCompile&&r.parallelShaderCompile.COMPLETION_STATUS_KHR&&i.program&&t.getProgramParameter(i.program,r.parallelShaderCompile.COMPLETION_STATUS_KHR)?(ve(i,t,e),!0):!1}function ve(s,t,e){let i=s.context,r=s.vertexShader,n=s.fragmentShader,a=s.program;if(!i.getProgramParameter(a,i.LINK_STATUS)){if(!t.getShaderParameter(r,t.COMPILE_STATUS)){let l=t.getShaderInfoLog(r);if(l)throw s.vertexCompilationError=l,new Error("VERTEX SHADER "+l)}if(!t.getShaderParameter(n,t.COMPILE_STATUS)){let l=t.getShaderInfoLog(n);if(l)throw s.fragmentCompilationError=l,new Error("FRAGMENT SHADER "+l)}let o=i.getProgramInfoLog(a);if(o)throw s.programLinkError=o,new Error(o)}if(e&&(i.validateProgram(a),!i.getProgramParameter(a,i.VALIDATE_STATUS))){let l=i.getProgramInfoLog(a);if(l)throw s.programValidationError=l,new Error(l)}i.deleteShader(r),i.deleteShader(n),s.vertexShader=void 0,s.fragmentShader=void 0,s.onCompiled&&(s.onCompiled(),s.onCompiled=void 0)}function vt(s,t,e,i,r,n,a,h,o,l="",f,c,u){let p=A(s.context);c||(c=p.createRawShaderProgramInjection??ze),u||(u=p.createShaderProgramInjection??Qe);let g=s;i?g.program=c(g,t,e,g.context,o):g.program=u(g,t,e,h,g.context,o),g.program.__SPECTOR_rebuildProgram=a,f()}function Fe(s,t,e,i,r,n){return re(Ce(s,e,i),t,r,n)}function re(s,t,e,i){let r=e.createShader(t==="vertex"?e.VERTEX_SHADER:e.FRAGMENT_SHADER);if(!r){let n=e.NO_ERROR,a=e.NO_ERROR;for(;(a=e.getError())!==e.NO_ERROR;)n=a;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${n}, gl isContextLost=${e.isContextLost()}, _contextWasLost=${i}`)}return e.shaderSource(r,s),e.compileShader(r),r}function Dt(s,t){t.useProgram(s)}function Rt(s,t){let e=s;if(!e.isParallelCompiled){t(s);return}let i=e.onCompiled;e.onCompiled=()=>{i?.(),t(s)}}var Je="attribute",et="varying",E=class{constructor(){this.children=[]}isValid(t){return!0}process(t,e,i){let r="";if(this.line){let n=this.line,a=e.processor;if(a){a.lineProcessor&&(n=a.lineProcessor(n,e.isFragment,e.processingContext));let h=e.processor?.attributeKeywordName??Je,o=e.isFragment&&e.processor?.varyingFragmentKeywordName?e.processor?.varyingFragmentKeywordName:!e.isFragment&&e.processor?.varyingVertexKeywordName?e.processor?.varyingVertexKeywordName:et;!e.isFragment&&a.attributeProcessor&&this.line.startsWith(h)?n=a.attributeProcessor(this.line,t,e.processingContext):a.varyingProcessor&&(a.varyingCheck?.(this.line,e.isFragment)||!a.varyingCheck&&this.line.startsWith(o))?n=a.varyingProcessor(this.line,e.isFragment,t,e.processingContext):a.uniformProcessor&&a.uniformRegexp&&a.uniformRegexp.test(this.line)?e.lookForClosingBracketForUniformBuffer||(n=a.uniformProcessor(this.line,e.isFragment,t,e.processingContext)):a.uniformBufferProcessor&&a.uniformBufferRegexp&&a.uniformBufferRegexp.test(this.line)?e.lookForClosingBracketForUniformBuffer||(n=a.uniformBufferProcessor(this.line,e.isFragment,e.processingContext),e.lookForClosingBracketForUniformBuffer=!0):a.textureProcessor&&a.textureRegexp&&a.textureRegexp.test(this.line)?n=a.textureProcessor(this.line,e.isFragment,t,e.processingContext):(a.uniformProcessor||a.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!e.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?a.uniformProcessor&&(n=a.uniformProcessor(this.line,e.isFragment,t,e.processingContext)):a.uniformBufferProcessor&&(n=a.uniformBufferProcessor(this.line,e.isFragment,e.processingContext),e.lookForClosingBracketForUniformBuffer=!0)),e.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(e.lookForClosingBracketForUniformBuffer=!1,a.endOfUniformBufferProcessor&&(n=a.endOfUniformBufferProcessor(this.line,e.isFragment,e.processingContext)))}r+=n+`
`}for(let n of this.children)r+=n.process(t,e,i);return this.additionalDefineKey&&(t[this.additionalDefineKey]=this.additionalDefineValue||"true",i[this.additionalDefineKey]=t[this.additionalDefineKey]),r}};var N=class{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(t){this._lines.length=0;for(let e of t){if(!e||e==="\r")continue;if(e[0]==="#"){this._lines.push(e);continue}let i=e.trim();if(!i)continue;if(i.startsWith("//")){this._lines.push(e);continue}let r=i.indexOf(";");if(r===-1)this._lines.push(i);else if(r===i.length-1)i.length>1&&this._lines.push(i);else{let n=e.split(";");for(let a=0;a<n.length;a++){let h=n[a];h&&(h=h.trim(),h&&this._lines.push(h+(a!==n.length-1?";":"")))}}}}};var M=class extends E{process(t,e,i){for(let r=0;r<this.children.length;r++){let n=this.children[r];if(n.isValid(t))return n.process(t,e,i)}return""}};var q=class extends E{isValid(t){return this.testExpression.isTrue(t)}};var x=class s{isTrue(t){return!0}static postfixToInfix(t){let e=[];for(let i of t)if(s._OperatorPriority[i]===void 0)e.push(i);else{let r=e[e.length-1],n=e[e.length-2];e.length-=2,e.push(`(${n}${i}${r})`)}return e[e.length-1]}static infixToPostfix(t){let e=s._InfixToPostfixCache.get(t);if(e)return e.accessTime=Date.now(),e.result;if(!t.includes("&&")&&!t.includes("||")&&!t.includes(")")&&!t.includes("("))return[t];let i=[],r=-1,n=()=>{f=f.trim(),f!==""&&(i.push(f),f="")},a=c=>{r<s._Stack.length-1&&(s._Stack[++r]=c)},h=()=>s._Stack[r],o=()=>r===-1?"!!INVALID EXPRESSION!!":s._Stack[r--],l=0,f="";for(;l<t.length;){let c=t.charAt(l),u=l<t.length-1?t.substring(l,2+l):"";if(c==="(")f="",a(c);else if(c===")"){for(n();r!==-1&&h()!=="(";)i.push(o());o()}else if(s._OperatorPriority[u]>1){for(n();r!==-1&&s._OperatorPriority[h()]>=s._OperatorPriority[u];)i.push(o());a(u),l++}else f+=c;l++}for(n();r!==-1;)h()==="("?o():i.push(o());return s._InfixToPostfixCache.size>=s.InfixToPostfixCacheLimitSize&&s.ClearCache(),s._InfixToPostfixCache.set(t,{result:i,accessTime:Date.now()}),i}static ClearCache(){let t=Array.from(s._InfixToPostfixCache.entries()).sort((e,i)=>e[1].accessTime-i[1].accessTime);for(let e=0;e<s.InfixToPostfixCacheCleanupSize;e++)s._InfixToPostfixCache.delete(t[e][0])}};x.InfixToPostfixCacheLimitSize=5e4;x.InfixToPostfixCacheCleanupSize=25e3;x._InfixToPostfixCache=new Map;x._OperatorPriority={")":0,"(":1,"||":2,"&&":3};x._Stack=["","","","","","","","","","","","","","","","","","","",""];var O=class extends x{constructor(t,e=!1){super(),this.define=t,this.not=e}isTrue(t){let e=t[this.define]!==void 0;return this.not&&(e=!e),e}};var $=class extends x{isTrue(t){return this.leftOperand.isTrue(t)||this.rightOperand.isTrue(t)}};var Y=class extends x{isTrue(t){return this.leftOperand.isTrue(t)&&this.rightOperand.isTrue(t)}};var Z=class extends x{constructor(t,e,i){super(),this.define=t,this.operand=e,this.testValue=i}toString(){return`${this.define} ${this.operand} ${this.testValue}`}isTrue(t){let e=!1,i=parseInt(t[this.define]!=null?t[this.define]:this.define),r=parseInt(t[this.testValue]!=null?t[this.testValue]:this.testValue);if(isNaN(i)||isNaN(r))return!1;switch(this.operand){case">":e=i>r;break;case"<":e=i<r;break;case"<=":e=i<=r;break;case">=":e=i>=r;break;case"==":e=i===r;break;case"!=":e=i!==r;break}return e}};var tt=/defined\s*?\((.+?)\)/g,ne=/defined\s*?\[(.+?)\]/g,it=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,st=/__decl__/,De=/light\{X\}.(\w*)/g,Re=/\{X\}/g,K=[],rt=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function Pe(s){s.processor&&s.processor.initializeShaders&&s.processor.initializeShaders(s.processingContext)}function le(s,t,e,i){t.processor?.preProcessShaderCode&&(s=t.processor.preProcessShaderCode(s,t.isFragment)),j(s,t,r=>{t.processCodeAfterIncludes&&(r=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",r,t.defines));let n=ht(r,t,i);e(n,r)})}function ti(s,t,e,i){t.processor?.preProcessShaderCode&&(s=t.processor.preProcessShaderCode(s,t.isFragment)),j(s,t,r=>{t.processCodeAfterIncludes&&(r=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",r,t.defines));let n=ot(r,t,i);e(n,r)})}function Ee(s,t,e){return!e.processor||!e.processor.finalizeShaders?{vertexCode:s,fragmentCode:t}:e.processor.finalizeShaders(s,t,e.processingContext)}function nt(s,t){if(t.processor?.noPrecision)return s;let e=t.shouldUseHighPrecisionShader;return s.indexOf("precision highp float")===-1?e?s=`precision highp float;
`+s:s=`precision mediump float;
`+s:e||(s=s.replace("precision highp float","precision mediump float")),s}function ae(s){let e=/defined\((.+)\)/.exec(s);if(e&&e.length)return new O(e[1].trim(),s[0]==="!");let i=["==","!=",">=","<=","<",">"],r="",n=0;for(r of i)if(n=s.indexOf(r),n>-1)break;if(n===-1)return new O(s);let a=s.substring(0,n).trim(),h=s.substring(n+r.length).trim();return new Z(a,r,h)}function at(s){s=s.replace(tt,"defined[$1]");let t=x.infixToPostfix(s),e=[];for(let r of t)if(r!=="||"&&r!=="&&")e.push(r);else if(e.length>=2){let n=e[e.length-1],a=e[e.length-2];e.length-=2;let h=r=="&&"?new Y:new $;typeof n=="string"&&(n=n.replace(ne,"defined($1)")),typeof a=="string"&&(a=a.replace(ne,"defined($1)")),h.leftOperand=typeof a=="string"?ae(a):a,h.rightOperand=typeof n=="string"?ae(n):n,e.push(h)}let i=e[e.length-1];return typeof i=="string"&&(i=i.replace(ne,"defined($1)")),typeof i=="string"?ae(i):i}function X(s,t){let e=new q,i=s.substring(0,t),r=s.substring(t);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),i==="#ifdef"?e.testExpression=new O(r):i==="#ifndef"?e.testExpression=new O(r,!0):e.testExpression=at(r),e}function he(s,t,e,i){let r=s.currentLine;for(;oe(s,e,i);){r=s.currentLine;let n=r.substring(0,5).toLowerCase();if(n==="#else"){let a=new E;t.children.push(a),oe(s,a,i);return}else if(n==="#elif"){let a=X(r,5);t.children.push(a),e=a}}}function oe(s,t,e){for(;s.canRead;){s.lineIndex++;let i=s.currentLine;if(i.indexOf("#")>=0){let n=rt.exec(i);if(n&&n.length){switch(n[0]){case"#ifdef":{let h=new M;t.children.push(h);let o=X(i,6);h.children.push(o),he(s,h,o,e);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{let h=new M;t.children.push(h);let o=X(i,7);h.children.push(o),he(s,h,o,e);break}case"#if":{let h=new M,o=X(i,3);t.children.push(h),h.children.push(o),he(s,h,o,e);break}}continue}}let r=new E;if(r.line=i,t.children.push(r),i[0]==="#"&&i[1]==="d"){let n=i.replace(";","").split(" ");r.additionalDefineKey=n[1],n.length===3&&(r.additionalDefineValue=n[2])}}return!1}function Ae(s,t,e,i){let r=new E,n=new N;return n.lineIndex=-1,n.lines=s.split(`
`),oe(n,r,i),r.process(t,e,i)}function Te(s,t){let e=s.defines,i={};for(let r of e){let a=r.replace("#define","").replace(";","").trim().split(" ");i[a[0]]=a.length>1?a[1]:""}return s.processor?.shaderLanguage===0&&(i.GL_ES="true"),i.__VERSION__=s.version,i[s.platformName]="true",xe(i,t?.isNDCHalfZRange,t?.useReverseDepthBuffer,t?.useExactSrgbConversions),i}function ht(s,t,e){let i=nt(s,t);if(!t.processor||t.processor.shaderLanguage===0&&i.indexOf("#version 3")!==-1&&(i=i.replace("#version 300 es",""),!t.processor.parseGLES3))return i;let r=t.defines,n=Te(t,e);t.processor.preProcessor&&(i=t.processor.preProcessor(i,r,n,t.isFragment,t.processingContext));let a={};return i=Ae(i,n,t,a),t.processor.postProcessor&&(i=t.processor.postProcessor(i,r,t.isFragment,t.processingContext,e?{drawBuffersExtensionDisabled:!e.getCaps().drawBuffersExtension}:{},n,a)),e?._features.needShaderCodeInlining&&(i=e.inlineShaderCode(i)),i}function ot(s,t,e){let i=s,r=t.defines,n=Te(t,e);t.processor?.preProcessor&&(i=t.processor.preProcessor(i,r,n,t.isFragment,t.processingContext));let a={};return i=Ae(i,n,t,a),t.processor?.postProcessor&&(i=t.processor.postProcessor(i,r,t.isFragment,t.processingContext,e?{drawBuffersExtensionDisabled:!e.getCaps().drawBuffersExtension}:{},n,a)),e._features.needShaderCodeInlining&&(i=e.inlineShaderCode(i)),i}function j(s,t,e){K.length=0;let i;for(;(i=it.exec(s))!==null;)K.push(i);let r=String(s),n=[s],a=!1;for(let h of K){let o=h[1];if(o.indexOf("__decl__")!==-1&&(o=o.replace(st,""),t.supportsUniformBuffers&&(o=o.replace("Vertex","Ubo").replace("Fragment","Ubo")),o=o+"Declaration"),t.includesShadersStore[o]){let l=t.includesShadersStore[o];if(h[2]){let c=h[3].split(",");for(let u=0;u<c.length;u+=2){let p=new RegExp(c[u],"g"),g=c[u+1];l=l.replace(p,g)}}if(h[4]){let c=h[5];if(c.indexOf("..")!==-1){let u=c.split(".."),p=parseInt(u[0]),g=parseInt(u[1]),b=l.slice(0);l="",isNaN(g)&&(g=t.indexParameters[u[1]]);for(let d=p;d<g;d++)t.supportsUniformBuffers||(b=b.replace(De,(R,B)=>B+"{X}")),l+=b.replace(Re,d.toString())+`
`}else t.supportsUniformBuffers||(l=l.replace(De,(u,p)=>p+"{X}")),l=l.replace(Re,c)}let f=[];for(let c of n){let u=c.split(h[0]);for(let p=0;p<u.length-1;p++)f.push(u[p]),f.push(l);f.push(u[u.length-1])}n=f,a=a||l.indexOf("#include<")>=0||l.indexOf("#include <")>=0}else{let l=t.shadersRepository+"ShadersInclude/"+o+".fx";lt.loadFile(l,f=>{t.includesShadersStore[o]=f,j(n.join(""),t,e)});return}}K.length=0,r=n.join(""),a?j(r.toString(),t,e):e(r)}var lt={loadFile:(s,t,e,i,r,n)=>{throw w("FileTools")}};function Le(s,t){return A(t).cachedPipelines[s]}function Me(s){let t=s._name,e=s.context;if(t&&e){let i=A(e);i.cachedPipelines[t]?.dispose(),delete i.cachedPipelines[t]}}function Ie(s,t,e,i,r,n,a){let h,o,l=P()?n?.getHostDocument():null;typeof t=="string"?h=t:t.vertexSource?h="source:"+t.vertexSource:t.vertexElement?h=l?.getElementById(t.vertexElement)||t.vertexElement:h=t.vertex||t,typeof t=="string"?o=t:t.fragmentSource?o="source:"+t.fragmentSource:t.fragmentElement?o=l?.getElementById(t.fragmentElement)||t.fragmentElement:o=t.fragment||t;let f=[void 0,void 0],c=()=>{if(f[0]&&f[1]){s.isFragment=!0;let[u,p]=f;le(p,s,(g,b)=>{a&&(a._fragmentSourceCodeBeforeMigration=b),e&&(g=e("fragment",g));let d=Ee(u,g,s);s=null;let R=ct(d.vertexCode,d.fragmentCode,t,r);i?.(R.vertexSourceCode,R.fragmentSourceCode)},n)}};Oe(h,"Vertex","",u=>{Pe(s),le(u,s,(p,g)=>{a&&(a._rawVertexSourceCode=u,a._vertexSourceCodeBeforeMigration=g),e&&(p=e("vertex",p)),f[0]=p,c()},n)},r),Oe(o,"Fragment","Pixel",u=>{a&&(a._rawFragmentSourceCode=u),f[1]=u,c()},r)}function Oe(s,t,e,i,r,n){if(typeof HTMLElement<"u"&&s instanceof HTMLElement){let o=ge(s);i(o);return}if(s.substring(0,7)==="source:"){i(s.substring(7));return}if(s.substring(0,7)==="base64:"){let o=window.atob(s.substring(7));i(o);return}let a=v.GetShadersStore(r);if(a[s+t+"Shader"]){i(a[s+t+"Shader"]);return}if(e&&a[s+e+"Shader"]){i(a[s+e+"Shader"]);return}let h;if(s[0]==="."||s[0]==="/"||s.indexOf("http")>-1?h=s:h=v.GetShadersRepository(r)+s,n=n||W,!n)throw new Error("loadFileInjection is not defined");n(h+"."+t.toLowerCase()+".fx",i)}function ct(s,t,e,i){if(e){let r=e.vertexElement||e.vertex||e.spectorName||e,n=e.fragmentElement||e.fragment||e.spectorName||e;return{vertexSourceCode:(i===1?"//":"")+"#define SHADER_NAME vertex:"+r+`
`+s,fragmentSourceCode:(i===1?"//":"")+"#define SHADER_NAME fragment:"+n+`
`+t}}else return{vertexSourceCode:s,fragmentSourceCode:t}}var ke=(s,t,e,i)=>{try{let r=s.context?A(s.context):null;r&&(r.disableParallelShaderCompile=s.disableParallelCompilation);let n=s.existingPipelineContext||t(s.shaderProcessingContext);return n._name=s.name,s.name&&r&&(r.cachedPipelines[s.name]=n),e(n,s.vertex,s.fragment,!!s.createAsRaw,"","",s.rebuildRebind,s.defines,s.transformFeedbackVaryings,"",()=>{i(n,()=>{s.onRenderingStateCompiled?.(n)})}),n}catch(r){throw C.Error("Error compiling effect"),r}};var D=class s{static get ShadersRepository(){return v.ShadersRepository}static set ShadersRepository(t){v.ShadersRepository=t}get isDisposed(){return this._isDisposed}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new m),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(t,e,i,r=null,n,a=null,h=null,o=null,l=null,f,c="",u=0,p){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new m,this.onErrorObservable=new m,this._onBindObservable=null,this._isDisposed=!1,this._refCount=1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._disableParallelShaderCompilation=!1,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=t,this._key=c;let g=this._key.replace(/\r/g,"").replace(/\n/g,"|"),b;if(e.attributes){let d=e;if(this._engine=i,this._attributesNames=d.attributes,this._uniformsNames=d.uniformsNames.concat(d.samplers),this._samplerList=d.samplers.slice(),this.defines=d.defines,this.onError=d.onError,this.onCompiled=d.onCompiled,this._fallbacks=d.fallbacks,this._indexParameters=d.indexParameters,this._transformFeedbackVaryings=d.transformFeedbackVaryings||null,this._multiTarget=!!d.multiTarget,this._shaderLanguage=d.shaderLanguage??0,this._disableParallelShaderCompilation=!!d.disableParallelShaderCompilation,d.uniformBuffersNames){this._uniformBuffersNamesList=d.uniformBuffersNames.slice();for(let R=0;R<d.uniformBuffersNames.length;R++)this._uniformBuffersNames[d.uniformBuffersNames[R]]=R}this._processFinalCode=d.processFinalCode??null,this._processCodeAfterIncludes=d.processCodeAfterIncludes??void 0,p=d.extraInitializationsAsync,b=d.existingPipelineContext}else this._engine=n,this.defines=a??"",this._uniformsNames=i.concat(r),this._samplerList=r?r.slice():[],this._attributesNames=e,this._uniformBuffersNamesList=[],this._shaderLanguage=u,this.onError=l,this.onCompiled=o,this._indexParameters=f,this._fallbacks=h;this._engine.shaderPlatformName==="WEBGL2"&&(b=Le(g,this._engine._gl)??b),this._attributeLocationByName={},this.uniqueId=s._UniqueIdSeed++,b?(this._pipelineContext=b,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,!1,null,p),this._engine.onReleaseEffectsObservable.addOnce(()=>{this.isDisposed||this.dispose(!0)})}async _processShaderCodeAsync(t=null,e=!1,i=null,r){r&&await r(),this._processingContext=i||this._engine._getShaderProcessingContext(this._shaderLanguage,!1);let n={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:t??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:v.GetShadersRepository(this._shaderLanguage),includesShadersStore:v.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};Ie(n,this.name,this._processFinalCode,(a,h)=>{this._vertexSourceCode=a,this._fragmentSourceCode=h,this._prepareEffect(e)},this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._engine.isDisposed||this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(t){return this._attributes[t]}getAttributeLocationByName(t){return this._attributeLocationByName[t]}getAttributesCount(){return this._attributes.length}getUniformIndex(t){return this._uniformsNames.indexOf(t)}getUniform(t){return this._uniforms[t]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}async whenCompiledAsync(){return await new Promise(t=>{this.executeWhenCompiled(t)})}executeWhenCompiled(t){if(this.isReady()){t(this);return}this.onCompileObservable.add(e=>{t(e)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&this._checkIsReady(null)}_checkIsReady(t){ye(()=>this._isReadyInternal()||this._isDisposed,()=>{},e=>{this._processCompilationErrors(e,t)},16,12e4,!0,` - Effect: ${typeof this.name=="string"?this.name:this.key}`)}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split(`
`),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride)}}}_rebuildProgram(t,e,i,r){this._isReady=!1,this._vertexSourceCodeOverride=t,this._fragmentSourceCodeOverride=e,this.onError=(n,a)=>{r&&r(a)},this.onCompiled=()=>{let n=this.getEngine().scenes;if(n)for(let a=0;a<n.length;a++)n[a].markAllMaterialsAsDirty(127);this._pipelineContext._handlesSpectorRebuildCallback?.(i)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(t){if(this._pipelineContext=t,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let e=0;e<this._attributesNames.length;e++){let i=this._attributesNames[e];this._attributeLocationByName[i]=this._attributes[e]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),s.AutomaticallyClearCodeCache&&this.clearCodeCache()}_prepareEffect(t=!1){let e=this._pipelineContext;this._isReady=!1;try{let i=!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride),r=i?null:this.defines,n=i?this._vertexSourceCodeOverride:this._vertexSourceCode,a=i?this._fragmentSourceCodeOverride:this._fragmentSourceCode,h=this._engine;this._pipelineContext=ke({existingPipelineContext:t?e:null,vertex:n,fragment:a,context:h.shaderPlatformName==="WEBGL2"||h.shaderPlatformName==="WEBGL1"?h._gl:void 0,rebuildRebind:(o,l,f,c)=>this._rebuildProgram(o,l,f,c),defines:r,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:i,disableParallelCompilation:this._disableParallelShaderCompilation,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:o=>{e&&!t&&this._engine._deletePipelineContext(e),o&&this._onRenderingStateCompiled(o)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContextAsync.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(e)}catch(i){this._processCompilationErrors(i,e)}}_getShaderCodeAndErrorLine(t,e,i){let r=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,n=null;if(e&&t){let a=e.match(r);if(a&&a.length===2){let h=parseInt(a[1]),o=t.split(`
`,-1);o.length>=h&&(n=`Offending line [${h}] in ${i?"fragment":"vertex"} code: ${o[h-1]}`)}}return[t,n]}_processCompilationErrors(t,e=null){this._compilationError=t.message;let i=this._attributesNames,r=this._fallbacks;if(C.Error("Unable to compile effect:"),C.Error(`Uniforms: ${this._uniformsNames.join(" ")}`),C.Error(`Attributes: ${i.join(" ")}`),C.Error(`Defines:
`+this.defines),s.LogShaderCodeOnCompilationError){let a=null,h=null,o=null;this._pipelineContext?._getVertexShaderCode()&&([o,a]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),o&&(C.Error("Vertex code:"),C.Error(o))),this._pipelineContext?._getFragmentShaderCode()&&([o,h]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,!0),o&&(C.Error("Fragment code:"),C.Error(o))),a&&C.Error(a),h&&C.Error(h)}C.Error("Error: "+this._compilationError);let n=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this._engine.onEffectErrorObservable.notifyObservers({effect:this,errors:this._compilationError})};e&&(this._pipelineContext=e,this._isReady=!0,n()),r?(this._pipelineContext=null,r.hasMoreFallbacks?(this._allFallbacksProcessed=!1,C.Error("Trying next fallback."),this.defines=r.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,n(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,e||n())}get isSupported(){return this._compilationError===""}_bindTexture(t,e){this._engine._bindTexture(this._samplers[t],e,t)}setTexture(t,e){this._engine.setTexture(this._samplers[t],this._uniforms[t],e,t)}setTextureArray(t,e){let i=t+"Ex";if(this._samplerList.indexOf(i+"0")===-1){let r=this._samplerList.indexOf(t);for(let a=1;a<e.length;a++){let h=i+(a-1).toString();this._samplerList.splice(r+a,0,h)}let n=0;for(let a of this._samplerList)this._samplers[a]=n,n+=1}this._engine.setTextureArray(this._samplers[t],this._uniforms[t],e,t)}bindUniformBuffer(t,e){let i=this._uniformBuffersNames[e];i===void 0||s._BaseCache[i]===t&&this._engine._features.useUBOBindingCache||(s._BaseCache[i]=t,this._engine.bindUniformBufferBase(t,i,e))}bindUniformBlock(t,e){this._engine.bindUniformBlock(this._pipelineContext,t,e)}setInt(t,e){return this._pipelineContext.setInt(t,e),this}setInt2(t,e,i){return this._pipelineContext.setInt2(t,e,i),this}setInt3(t,e,i,r){return this._pipelineContext.setInt3(t,e,i,r),this}setInt4(t,e,i,r,n){return this._pipelineContext.setInt4(t,e,i,r,n),this}setIntArray(t,e){return this._pipelineContext.setIntArray(t,e),this}setIntArray2(t,e){return this._pipelineContext.setIntArray2(t,e),this}setIntArray3(t,e){return this._pipelineContext.setIntArray3(t,e),this}setIntArray4(t,e){return this._pipelineContext.setIntArray4(t,e),this}setUInt(t,e){return this._pipelineContext.setUInt(t,e),this}setUInt2(t,e,i){return this._pipelineContext.setUInt2(t,e,i),this}setUInt3(t,e,i,r){return this._pipelineContext.setUInt3(t,e,i,r),this}setUInt4(t,e,i,r,n){return this._pipelineContext.setUInt4(t,e,i,r,n),this}setUIntArray(t,e){return this._pipelineContext.setUIntArray(t,e),this}setUIntArray2(t,e){return this._pipelineContext.setUIntArray2(t,e),this}setUIntArray3(t,e){return this._pipelineContext.setUIntArray3(t,e),this}setUIntArray4(t,e){return this._pipelineContext.setUIntArray4(t,e),this}setFloatArray(t,e){return this._pipelineContext.setArray(t,e),this}setFloatArray2(t,e){return this._pipelineContext.setArray2(t,e),this}setFloatArray3(t,e){return this._pipelineContext.setArray3(t,e),this}setFloatArray4(t,e){return this._pipelineContext.setArray4(t,e),this}setArray(t,e){return this._pipelineContext.setArray(t,e),this}setArray2(t,e){return this._pipelineContext.setArray2(t,e),this}setArray3(t,e){return this._pipelineContext.setArray3(t,e),this}setArray4(t,e){return this._pipelineContext.setArray4(t,e),this}setMatrices(t,e){return this._pipelineContext.setMatrices(t,e),this}setMatrix(t,e){return this._pipelineContext.setMatrix(t,e),this}setMatrix3x3(t,e){return this._pipelineContext.setMatrix3x3(t,e),this}setMatrix2x2(t,e){return this._pipelineContext.setMatrix2x2(t,e),this}setFloat(t,e){return this._pipelineContext.setFloat(t,e),this}setBool(t,e){return this._pipelineContext.setInt(t,e?1:0),this}setVector2(t,e){return this._pipelineContext.setVector2(t,e),this}setFloat2(t,e,i){return this._pipelineContext.setFloat2(t,e,i),this}setVector3(t,e){return this._pipelineContext.setVector3(t,e),this}setFloat3(t,e,i,r){return this._pipelineContext.setFloat3(t,e,i,r),this}setVector4(t,e){return this._pipelineContext.setVector4(t,e),this}setQuaternion(t,e){return this._pipelineContext.setQuaternion(t,e),this}setFloat4(t,e,i,r,n){return this._pipelineContext.setFloat4(t,e,i,r,n),this}setColor3(t,e){return this._pipelineContext.setColor3(t,e),this}setColor4(t,e,i){return this._pipelineContext.setColor4(t,e,i),this}setDirectColor4(t,e){return this._pipelineContext.setDirectColor4(t,e),this}clearCodeCache(){this._vertexSourceCode="",this._fragmentSourceCode="",this._fragmentSourceCodeBeforeMigration="",this._vertexSourceCodeBeforeMigration=""}dispose(t=!1){if(t)this._refCount=0;else{if(s.PersistentMode)return;this._refCount--}this._refCount>0||this._isDisposed||(this._pipelineContext&&Me(this._pipelineContext),this._engine._releaseEffect(this),this.clearCodeCache(),this._isDisposed=!0)}static RegisterShader(t,e,i,r=0){e&&(v.GetShadersStore(r)[`${t}PixelShader`]=e),i&&(v.GetShadersStore(r)[`${t}VertexShader`]=i)}static ResetCache(){s._BaseCache={}}};D.LogShaderCodeOnCompilationError=!0;D.PersistentMode=!1;D.AutomaticallyClearCodeCache=!1;D._UniqueIdSeed=0;D._BaseCache={};D.ShadersStore=v.ShadersStore;D.IncludesShadersStore=v.IncludesShadersStore;var z=class{get wrapU(){return this._cachedWrapU}set wrapU(t){this._cachedWrapU=t}get wrapV(){return this._cachedWrapV}set wrapV(t){this._cachedWrapV=t}get wrapR(){return this._cachedWrapR}set wrapR(t){this._cachedWrapR=t}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(t){this._cachedAnisotropicFilteringLevel=t}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(t){this._comparisonFunction=t}get useMipMaps(){return this._useMipMaps}set useMipMaps(t){this._useMipMaps=t}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(t=1,e=1,i=1,r=1,n=2,a=0){return this._cachedWrapU=t,this._cachedWrapV=e,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=n,this._comparisonFunction=a,this}compareSampler(t){return this._cachedWrapU===t._cachedWrapU&&this._cachedWrapV===t._cachedWrapV&&this._cachedWrapR===t._cachedWrapR&&this._cachedAnisotropicFilteringLevel===t._cachedAnisotropicFilteringLevel&&this.samplingMode===t.samplingMode&&this._comparisonFunction===t._comparisonFunction&&this._useMipMaps===t._useMipMaps}};var Be=(()=>{class s extends z{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,i,r=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new m,this.onErrorObservable=new m,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._autoMSAAManagement=!1,this._engine=e,this._source=i,this._uniqueId=s._Counter++,r||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,i,r=1){this._engine.updateTextureDimensions(this,e,i,r),this.width=e,this.height=i,this.depth=r,this.baseWidth=e,this.baseHeight=i,this.baseDepth=r,this._size=e*i*r}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){let i=this.onRebuildCallback(this),r=n=>{n._swapAndDie(this,!1),this.isReady=i.isReady};i.isAsync?i.proxy.then(r):r(i.proxy);return}let e;switch(this.source){case 2:break;case 1:e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,i=>{i._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case 7:e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{e._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null);return;case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case 13:return;case 9:e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,i=>{i&&i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),e._sphericalPolynomial=this._sphericalPolynomial;return;case 12:case 14:break}}_swapAndDie(e,i=!0){this._hardwareTexture?.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,i&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);let r=this._engine.getLoadedTexturesCache(),n=r.indexOf(this);n!==-1&&r.splice(n,1),n=r.indexOf(e),n===-1&&r.push(e)}dispose(){this._references--,this._references===0&&(this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}return s._Counter=0,s})();function bi(s){let t=1;do t*=2;while(t<s);return t===s}function Si(s,t,e){return s*(1-e)+t*e}function ut(s){let t=Ue(s),e=Ve(s);return t-s>s-e?e:t}function Ue(s){return s--,s|=s>>1,s|=s>>2,s|=s>>4,s|=s>>8,s|=s>>16,s++,s}function Ve(s){return s=s|s>>1,s=s|s>>2,s=s|s>>4,s=s|s>>8,s=s|s>>16,s-(s>>1)}function yi(s,t,e=2){let i;switch(e){case 1:i=Ve(s);break;case 2:i=ut(s);break;case 3:default:i=Ue(s);break}return Math.min(i,t)}var Q=class{constructor(t=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,t&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(t){this._zOffset!==t&&(this._zOffset=t,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(t){this._zOffsetUnits!==t&&(this._zOffsetUnits=t,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(t){this._cullFace!==t&&(this._cullFace=t,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(t){this._cull!==t&&(this._cull=t,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(t){this._depthFunc!==t&&(this._depthFunc=t,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(t){this._depthMask!==t&&(this._depthMask=t,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(t){this._depthTest!==t&&(this._depthTest=t,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(t){this._frontFace!==t&&(this._frontFace=t,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(t){this.isDirty&&(this._isCullDirty&&(this.cull?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(t.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(t.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(t.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(this.zOffset,this.zOffsetUnits)):t.disable(t.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(t.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}};var J=class{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(t){this._func!==t&&(this._func=t,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(t){this._funcRef!==t&&(this._funcRef=t,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(t){this._funcMask!==t&&(this._funcMask=t,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(t){this._opStencilFail!==t&&(this._opStencilFail=t,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(t){this._opDepthFail!==t&&(this._opDepthFail=t,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(t){this._opStencilDepthPass!==t&&(this._opStencilDepthPass=t,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(this._enabled=t,this._isStencilTestDirty=!0)}constructor(t=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,t&&this.reset()}reset(){this.stencilMaterial=void 0,this.stencilGlobal?.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(t){if(!t)return;let e=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(t.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(t.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(t.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}};var We=(()=>{class s{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=s.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=s.KEEP,this.opDepthFail=s.KEEP,this.opStencilDepthPass=s.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}return s.ALWAYS=519,s.KEEP=7680,s.REPLACE=7681,s})();var ee=class{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(t){this._alphaBlend!==t&&(this._alphaBlend=t,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(t,e,i,r){this._blendConstants[0]===t&&this._blendConstants[1]===e&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=t,this._blendConstants[1]=e,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(t,e,i,r){this._blendFunctionParameters[0]===t&&this._blendFunctionParameters[1]===e&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=t,this._blendFunctionParameters[1]=e,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(t,e){this._blendEquationParameters[0]===t&&this._blendEquationParameters[1]===e||(this._blendEquationParameters[0]=t,this._blendEquationParameters[1]=e,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(t){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?t.enable(t.BLEND):t.disable(t.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(t.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(t.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(t.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}};var te=new Map;function T(s,t){ft(s)&&C.Warn(`Extension with the name '${s}' already exists`),te.set(s,t)}function ft(s){return te.delete(s)}function He(s,t){(t==="image/ktx"||t==="image/ktx2")&&(s=".ktx"),te.has(s)||(s.endsWith(".ies")&&T(".ies",async()=>await import("./chunk-XD35Z4HS.js").then(i=>new i._IESTextureLoader)),s.endsWith(".dds")&&T(".dds",async()=>await import("./chunk-4ZTNQX45.js").then(i=>new i._DDSTextureLoader)),s.endsWith(".basis")&&T(".basis",async()=>await import("./chunk-SBP2M2AX.js").then(i=>new i._BasisTextureLoader)),s.endsWith(".env")&&T(".env",async()=>await import("./chunk-4PGHQXAQ.js").then(i=>new i._ENVTextureLoader)),s.endsWith(".hdr")&&T(".hdr",async()=>await import("./chunk-GFBZ6BU4.js").then(i=>new i._HDRTextureLoader)),(s.endsWith(".ktx")||s.endsWith(".ktx2"))&&(T(".ktx",async()=>await import("./chunk-ZBH5L5IF.js").then(i=>new i._KTXTextureLoader)),T(".ktx2",async()=>await import("./chunk-ZBH5L5IF.js").then(i=>new i._KTXTextureLoader))),s.endsWith(".tga")&&T(".tga",async()=>await import("./chunk-ZKGCOKKO.js").then(i=>new i._TGATextureLoader)),s.endsWith(".exr")&&T(".exr",async()=>await import("./chunk-E2BBO7IH.js").then(i=>new i._ExrTextureLoader)));let e=te.get(s);return e?Promise.resolve(e(t)):null}function Ge(s,t){if(P()){let{requestAnimationFrame:e}=t||window;if(typeof e=="function")return e(s)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(s);return setTimeout(s,16)}var $i=(()=>{class s{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let i="";return this.isNDCHalfZRange&&(i+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(i&&(i+=`
`),i+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(i&&(i+=`
`),i+="#define USE_EXACT_SRGB_CONVERSIONS"),i}}_rebuildInternalTextures(){let e=this._internalTexturesCache.slice();for(let i of e)i._rebuild()}_rebuildRenderTargetWrappers(){let e=this._renderTargetWrapperCache.slice();for(let i of e)i._rebuild()}_rebuildEffects(){for(let e in this._compiledEffects){let i=this._compiledEffects[e];i._pipelineContext=null,i._prepareEffect()}D.ResetCache()}_rebuildGraphicsResources(){this.wipeCaches(!0),this._rebuildEffects(),this._rebuildComputeEffects?.(),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){C.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(e){setTimeout(()=>{this._clearEmptyResources();let i=this._depthCullingState.depthTest,r=this._depthCullingState.depthFunc,n=this._depthCullingState.depthMask,a=this._stencilState.stencilTest;e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=r,this._depthCullingState.depthMask=n,this._stencilState.stencilTest=a,this._flagContextRestored()},0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(e){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){let e=new Uint8Array(4),i=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(i,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0,this._cancelFrame();return}let i=this._activeRenderLoops.indexOf(e);i>=0&&(this._activeRenderLoops.splice(i,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._frameHandler!==0){let e=this._frameHandler;if(this._frameHandler=0,P()){let{cancelAnimationFrame:i}=this.getHostWindow()||window;if(typeof i=="function")return i(e)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}get maxFPS(){return this._maxFPS}set maxFPS(e){if(this._maxFPS=e,e!==void 0){if(e<=0){this._minFrameTime=Number.MAX_VALUE;return}this._minFrameTime=1e3/e}}_isOverFrameTime(e){if(!e||this._maxFPS===void 0)return!1;let i=e-this._lastFrameTime;return this._lastFrameTime=e,this._renderAccumulator+=i,this._renderAccumulator<this._minFrameTime?!0:(this._renderAccumulator-=this._minFrameTime,this._renderAccumulator>this._minFrameTime&&(this._renderAccumulator=this._minFrameTime),!1)}_processFrame(e){if(this._frameHandler=0,!this._contextWasLost&&!this._isOverFrameTime(e)){let i=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(i=!1),i&&(this.beginFrame(),!this.skipFrameRender&&!this._renderViews()&&this._renderFrame(),this.endFrame())}}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){let i=this._activeRenderLoops[e];i()}}_renderViews(){return!1}_queueNewFrame(e,i){return Ge(e,i)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._activeRenderLoops.length===1&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){let e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){let e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return P()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}_rebuildTextures(){for(let e of this.scenes)e._rebuildTextures();for(let e of this._virtualScenes)e._rebuildTextures()}_releaseRenderTargetWrapper(e){let i=this._renderTargetWrapperCache.indexOf(e);i!==-1&&this._renderTargetWrapperCache.splice(i,1)}get currentViewport(){return this._cachedViewport}setViewport(e,i,r){let n=i||this.getRenderWidth(),a=r||this.getRenderHeight(),h=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(h*n,o*a,n*e.width,a*e.height)}createCanvasImage(){return document.createElement("img")}createCanvasPath2D(e){return new Path2D(e)}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,i,r,n,a=3,h=null,o=null,l,f,c=null,u=null,p=null,g=null,b,d,R){e=e||"";let B=e.substring(0,5)==="data:",Ne=e.substring(0,5)==="blob:",ce=B&&e.indexOf(";base64,")!==-1,_=u||new Be(this,1);_!==u&&(_.label=e.substring(0,60));let I=e;this._transformTextureUrl&&!ce&&!u&&!c&&(e=this._transformTextureUrl(e)),I!==e&&(_._originalUrl=I);let ue=e.lastIndexOf("."),L=g||(ue>-1?e.substring(ue).toLowerCase():"");L.indexOf("?")>-1&&(L=L.split("?")[0]);let fe=He(L,b);n&&n.addPendingData(_),_.url=e,_.generateMipMaps=!i,_.samplingMode=a,_.invertY=r,_._useSRGBBuffer=this._getUseSRGBBuffer(!!R,i),this._doNotHandleContextLost||(_._buffer=c);let ie=null;h&&!u&&(ie=_.onLoadedObservable.add(h)),u||this._internalTexturesCache.push(_);let U=(S,F)=>{n&&n.removePendingData(_),e===I?(ie&&_.onLoadedObservable.remove(ie),y.UseFallbackTexture&&e!==y.FallbackTexture&&this._createTextureBase(y.FallbackTexture,i,_.invertY,n,a,null,o,l,f,c,_),S=(S||"Unknown error")+(y.UseFallbackTexture?" - Fallback texture was used":""),_.onErrorObservable.notifyObservers({message:S,exception:F}),o&&o(S,F)):(C.Warn(`Failed to load ${e}, falling back to ${I}`),this._createTextureBase(I,i,_.invertY,n,a,h,o,l,f,c,_,p,g,b,d,R))};if(fe){let S=async F=>{(await fe).loadData(F,_,(qe,$e,Ye,Ze,Ke,Xe)=>{Xe?U("TextureLoader failed to load data"):l(_,L,n,{width:qe,height:$e},_.invertY,!Ye,Ze,()=>(Ke(),!1),a)},d)};c?c instanceof ArrayBuffer?S(new Uint8Array(c)):ArrayBuffer.isView(c)?S(c):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,F=>{S(new Uint8Array(F))},void 0,n?n.offlineProvider:void 0,!0,(F,de)=>{U("Unable to load "+(F&&F.responseURL,de))})}else{let S=F=>{Ne&&!this._doNotHandleContextLost&&(_._buffer=F),l(_,L,n,F,_.invertY,i,!1,f,a)};!B||ce?c&&(typeof c.decoding=="string"||c.close)?S(c):s._FileToolsLoadImage(e||"",S,U,n?n.offlineProvider:null,b,_.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):typeof c=="string"||c instanceof ArrayBuffer||ArrayBuffer.isView(c)||c instanceof Blob?s._FileToolsLoadImage(c,S,U,n?n.offlineProvider:null,b,_.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):c&&S(c)}return _}_rebuildBuffers(){for(let e of this._uniformBuffers)e._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:k()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(let e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(e){this._name=e}static get NpmPackage(){return"babylonjs@8.15.1"}static get Version(){return"8.15.1"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,i,r){this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Q,this._stencilStateComposer=new J,this._stencilState=new We,this._alphaState=new ee,this._alphaMode=1,this._alphaEquation=0,this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new m,this.onCanvasFocusObservable=new m,this.onNewSceneAddedObservable=new m,this.onResizeObservable=new m,this.onCanvasPointerOutObservable=new m,this.onEffectErrorObservable=new m,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new m,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=h=>this._renderLoop(h),this._lastFrameTime=0,this._renderAccumulator=0,this.skipFrameRender=!1,this.onBeforeShaderCompilationObservable=new m,this.onAfterShaderCompilationObservable=new m,this.onBeginFrameObservable=new m,this.onEndFrameObservable=new m,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new m,this.onContextRestoredObservable=new m,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new m,this.onReleaseEffectsObservable=new m,y.Instances.push(this),this.startTime=me.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,_e.SetMatrixPrecision(!!i.useHighPrecisionMatrix),pe()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=r??!1,i.antialias=e??i.antialias,i.deterministicLockstep=i.deterministicLockstep??!1,i.lockstepMaxSteps=i.lockstepMaxSteps??4,i.timeStep=i.timeStep??1/60,i.stencil=i.stencil??!0,this._audioContext=i.audioEngineOptions?.audioContext??null,this._audioDestination=i.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=i.premultipliedAlpha??!0,this._doNotHandleContextLost=!!i.doNotHandleContextLost,this._isStencilEnable=!!i.stencil,this.useExactSrgbConversions=i.useExactSrgbConversions??!1;let n=P()&&window.devicePixelRatio||1,a=i.limitDeviceRatio||n;r=r||i.adaptToDeviceRatio||!1,this._hardwareScalingLevel=r?1/Math.min(a,n):1,this._lastDevicePixelRatio=n,this._creationOptions=i}resize(e=!1){let i,r;if(this.adaptToDeviceRatio){let n=P()&&window.devicePixelRatio||1,a=this._lastDevicePixelRatio/n;this._lastDevicePixelRatio=n,this._hardwareScalingLevel*=a}if(P()&&k())if(this._renderingCanvas){let n=this._renderingCanvas.getBoundingClientRect?.();i=this._renderingCanvas.clientWidth||n?.width||this._renderingCanvas.width*this._hardwareScalingLevel||100,r=this._renderingCanvas.clientHeight||n?.height||this._renderingCanvas.height*this._hardwareScalingLevel||100}else i=window.innerWidth,r=window.innerHeight;else i=this._renderingCanvas?this._renderingCanvas.width:100,r=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(i/this._hardwareScalingLevel,r/this._hardwareScalingLevel,e)}setSize(e,i,r=!1){if(!this._renderingCanvas||(e=e|0,i=i|0,!r&&this._renderingCanvas.width===e&&this._renderingCanvas.height===i))return!1;if(this._renderingCanvas.width=e,this._renderingCanvas.height=i,this.scenes){for(let n=0;n<this.scenes.length;n++){let a=this.scenes[n];for(let h=0;h<a.cameras.length;h++){let o=a.cameras[h];o._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(e,i,r,n,a,h,o,l,f,c,u){throw w("engine.rawTexture")}createRawCubeTexture(e,i,r,n,a,h,o,l){throw w("engine.rawTexture")}createRawTexture3D(e,i,r,n,a,h,o,l,f,c,u){throw w("engine.rawTexture")}createRawTexture2DArray(e,i,r,n,a,h,o,l,f,c,u){throw w("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{let e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&k()&&"ontouchend"in document},this._checkForMobile(),P()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){this._drawCalls?.addCount(e,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}_createImageBitmapFromSource(e,i){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,i){return createImageBitmap(e,i)}resizeImageBitmap(e,i,r){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,i){if(typeof document>"u")return new OffscreenCanvas(e,i);let r=document.createElement("canvas");return r.width=e,r.height=i,r}createCanvas(e,i){return s._CreateCanvas(e,i)}static _FileToolsLoadImage(e,i,r,n,a,h,o){throw w("FileTools")}_loadFile(e,i,r,n,a,h){let o=W(e,i,r,n,a,h);return this._activeRequests.push(o),o.onCompleteObservable.add(()=>{let l=this._activeRequests.indexOf(o);l!==-1&&this._activeRequests.splice(l,1)}),o}static _FileToolsLoadFile(e,i,r,n,a,h){if(V.loadFile)return V.loadFile(e,i,r,n,a,h);throw w("FileTools")}dispose(){for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();this.releaseComputeEffects?.(),D.ResetCache();for(let i of this._activeRequests)i.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),this.onEffectErrorObservable.clear(),P()&&window.removeEventListener("resize",this._checkForMobile);let e=y.Instances.indexOf(this);e>=0&&y.Instances.splice(e,1),y.Instances.length||(y.OnEnginesDisposedObservable.notifyObservers(this),y.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(e){throw w("LoadingScreen")}static MarkAllMaterialsAsDirty(e,i){for(let r=0;r<y.Instances.length;r++){let n=y.Instances[r];for(let a=0;a<n.scenes.length;a++)n.scenes[a].markAllMaterialsAsDirty(e,i)}}}return s._RenderPassIdCounter=0,s._RescalePostProcessFactory=null,s.CollisionsEpsilon=.001,s.QueueNewFrame=Ge,s})();export{V as a,Ce as b,xe as c,gt as d,Pe as e,le as f,ti as g,Ee as h,j as i,lt as j,be as k,ye as l,A as m,yt as n,ze as o,Qe as p,Ft as q,we as r,wt as s,ve as t,vt as u,Dt as v,Rt as w,Me as x,D as y,Q as z,J as A,z as B,Be as C,bi as D,Si as E,ut as F,Ve as G,yi as H,He as I,$i as J};
